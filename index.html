<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anonymous Messenger</title>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:#f0f2f5;height:100vh}
.view{height:100vh;display:flex;flex-direction:column}
.header{background:#1877f2;color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
.users,.messages{flex:1;background:#fff;overflow-y:auto}
.user{padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
.user.you{background:#f5f5f5;font-weight:bold}
.user.friend{background:#f0f8ff}
.left{display:flex;align-items:center;gap:10px}
.avatar{width:36px;height:36px;border-radius:50%;background:#ccc;background-size:cover;background-position:center}
.badge{background:#ff3b30;color:#fff;border-radius:10px;padding:2px 6px;font-size:11px;display:none}
button{padding:6px 10px}
.hidden{display:none}
.msg{max-width:75%;margin:6px;padding:10px 14px;border-radius:18px}
.me{background:#1877f2;color:#fff;margin-left:auto}
.them{background:#e4e6eb}
.inputBar{display:flex;padding:10px;border-top:1px solid #ddd}
textarea{flex:1;resize:none;padding:10px;border-radius:20px;border:1px solid #ccc}
.actions button{margin-left:6px}
</style>
</head>

<body>

<!-- CONTACTS -->
<div id="contacts" class="view">
  <div class="header">
    <span>Contacts</span>
    <button onclick="openProfile()">ðŸ‘¤</button>
  </div>
  <div class="users" id="users"></div>
</div>

<!-- CHAT -->
<div id="chat" class="view hidden">
  <div class="header">
    <button onclick="closeChat()">â¬…</button>
    <span id="chatTitle"></span>
  </div>
  <div class="messages" id="messages"></div>
  <div class="inputBar">
    <textarea id="msgInput" rows="1" placeholder="Type a message"></textarea>
  </div>
</div>

<!-- PROFILE -->
<div id="profile" class="view hidden">
  <div class="header">
    <button onclick="closeProfile()">â¬…</button>
    <span>Your Profile</span>
  </div>
  <input id="nameInput" placeholder="Username (optional)" style="margin:10px;padding:10px">
  <input type="file" accept="image/*" onchange="setAvatar(this)" style="margin:10px">
  <button onclick="saveProfile()" style="margin:10px">Save</button>
</div>

<script>
/* ===== Identity ===== */
let myId=localStorage.getItem("anon_id");
if(!myId){myId=crypto.randomUUID().replace(/-/g,"");localStorage.setItem("anon_id",myId);}

/* ===== Profile ===== */
let profile=JSON.parse(localStorage.getItem("profile")||"{}");

/* ===== State ===== */
let friends=JSON.parse(localStorage.getItem("friends")||"[]");
let trusted=JSON.parse(localStorage.getItem("trusted")||"[]");
let pendingIn=JSON.parse(localStorage.getItem("pendingIn")||"[]");
let pendingOut=JSON.parse(localStorage.getItem("pendingOut")||"[]");
let unread=JSON.parse(localStorage.getItem("unread")||"{}");
let chatMemory={};
let online=new Map();
let activeChat=null;

/* ===== DOM ===== */
const users=document.getElementById("users");
const contacts=document.getElementById("contacts");
const chat=document.getElementById("chat");
const profileView=document.getElementById("profile");
const messages=document.getElementById("messages");
const chatTitle=document.getElementById("chatTitle");
const msgInput=document.getElementById("msgInput");
const nameInput=document.getElementById("nameInput");

/* ===== WebSocket ===== */
const ws=new WebSocket("wss://anon-messenger-server-production.up.railway.app");

ws.onopen=()=>{
  ws.send(JSON.stringify({type:"hello",id:myId,profile}));
};

ws.onmessage=e=>{
  const d=JSON.parse(e.data);

  if(d.type==="online"){
    online=new Map(d.users.map(u=>[u.id,u]));
    renderUsers();
  }

  if(d.type==="relay"){
    const from=d.from;
    const text=d.payload.text;

    if(text==="[request]"){
      if(!pendingIn.includes(from))pendingIn.push(from);
      save();renderUsers();return;
    }

    if(text==="[cancel]"){
      pendingIn=pendingIn.filter(x=>x!==from);
      save();renderUsers();return;
    }

    if(text==="[accepted]"){
      friends.push(from);trusted.push(from);
      pendingOut=pendingOut.filter(x=>x!==from);
      save();renderUsers();return;
    }

    chatMemory[from]=chatMemory[from]||[];
    chatMemory[from].push({text,who:"them"});
    if(activeChat===from)addMessage(text,"them");
    else{unread[from]=(unread[from]||0)+1;save();renderUsers();}
  }
};

/* ===== UI ===== */
function displayName(id){
  const u=online.get(id);
  return u?.profile?.name||id.slice(0,12);
}
function avatarUrl(id){
  return online.get(id)?.profile?.avatar||"";
}

function renderUsers(){
  users.innerHTML="";
  addRow(myId,true);
  [...online.keys()].filter(id=>id!==myId).forEach(id=>addRow(id,false));
}

function addRow(id,isYou){
  const div=document.createElement("div");
  div.className="user"+(isYou?" you":"")+(friends.includes(id)?" friend":"");
  const left=document.createElement("div");left.className="left";
  const av=document.createElement("div");av.className="avatar";
  if(isYou&&profile.avatar)av.style.backgroundImage=`url(${profile.avatar})`;
  if(!isYou&&avatarUrl(id))av.style.backgroundImage=`url(${avatarUrl(id)})`;
  const name=document.createElement("span");name.textContent=isYou?"You":displayName(id);
  left.append(av,name);

  const actions=document.createElement("div");actions.className="actions";

  if(isYou){
    const b=document.createElement("button");
    b.textContent="Copy ID";
    b.onclick=()=>navigator.clipboard.writeText(myId);
    actions.append(b);
  }
  else if(pendingIn.includes(id)){
    ["Accept","Reject"].forEach(t=>{
      const b=document.createElement("button");b.textContent=t;
      b.onclick=()=>{
        pendingIn=pendingIn.filter(x=>x!==id);
        if(t==="Accept"){
          friends.push(id);trusted.push(id);
          ws.send(JSON.stringify({type:"relay",to:id,payload:{text:"[accepted]"}}));
        }
        save();renderUsers();
      };
      actions.append(b);
    });
  }
  else if(pendingOut.includes(id)){
    const b=document.createElement("button");
    b.textContent="Request Sent";
    b.onclick=()=>{
      pendingOut=pendingOut.filter(x=>x!==id);
      ws.send(JSON.stringify({type:"relay",to:id,payload:{text:"[cancel]"}}));
      save();renderUsers();
    };
    actions.append(b);
  }
  else if(!friends.includes(id)){
    const b=document.createElement("button");
    b.textContent="Add Friend";
    b.onclick=()=>{
      pendingOut.push(id);
      ws.send(JSON.stringify({type:"relay",to:id,payload:{text:"[request]"}}));
      save();renderUsers();
    };
    actions.append(b);
  }
  else{
    const chatBtn=document.createElement("button");
    chatBtn.textContent="Chat";
    chatBtn.onclick=()=>openChat(id);
    const unfriend=document.createElement("button");
    unfriend.textContent="Unfriend";
    unfriend.onclick=()=>{
      friends=friends.filter(x=>x!==id);
      trusted=trusted.filter(x=>x!==id);
      save();renderUsers();
    };
    actions.append(chatBtn,unfriend);
  }

  div.append(left,actions);
  users.appendChild(div);
}

/* ===== Chat ===== */
function openChat(id){
  activeChat=id;
  unread[id]=0;save();
  messages.innerHTML="";
  (chatMemory[id]||[]).forEach(m=>addMessage(m.text,m.who));
  chatTitle.textContent=displayName(id);
  contacts.classList.add("hidden");
  chat.classList.remove("hidden");
}
function closeChat(){
  if(activeChat)delete chatMemory[activeChat];
  activeChat=null;
  chat.classList.add("hidden");
  contacts.classList.remove("hidden");
  renderUsers();
}
function addMessage(text,who){
  const d=document.createElement("div");
  d.className="msg "+who;
  d.textContent=text;
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}
msgInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}
});
function sendMessage(){
  if(!activeChat||!msgInput.value.trim())return;
  ws.send(JSON.stringify({type:"relay",to:activeChat,payload:{text:msgInput.value}}));
  addMessage(msgInput.value,"me");
  chatMemory[activeChat].push({text:msgInput.value,who:"me"});
  msgInput.value="";
}

/* ===== Profile ===== */
function openProfile(){contacts.classList.add("hidden");profileView.classList.remove("hidden");nameInput.value=profile.name||"";}
function closeProfile(){profileView.classList.add("hidden");contacts.classList.remove("hidden");}
function setAvatar(i){const r=new FileReader();r.onload=()=>profile.avatar=r.result;r.readAsDataURL(i.files[0]);}
function saveProfile(){profile.name=nameInput.value.trim();save();closeProfile();}

/* ===== Utils ===== */
function save(){
  localStorage.setItem("friends",JSON.stringify(friends));
  localStorage.setItem("trusted",JSON.stringify(trusted));
  localStorage.setItem("pendingIn",JSON.stringify(pendingIn));
  localStorage.setItem("pendingOut",JSON.stringify(pendingOut));
  localStorage.setItem("unread",JSON.stringify(unread));
  localStorage.setItem("profile",JSON.stringify(profile));
}

renderUsers();
</script>
</body>
</html>
