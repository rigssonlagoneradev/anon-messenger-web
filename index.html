<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AnonyMouse</title>

<!-- Supabase CDN (ONLY ONCE) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg: #f2f4f8;
  --card: #ffffff;
  --blue: #1f6feb;
}

* { box-sizing: border-box; font-family: system-ui, -apple-system; }

html, body {
  margin: 0;
  height: 100%;
  background: var(--bg);
}

/* CENTERED AUTH CARD */
.center {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

.card {
  width: 320px;
  background: var(--card);
  padding: 24px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.1);
  text-align: center;
}

.logo {
  width: 60px;
  height: 60px;
  margin: 0 auto 10px;
}

h2 { margin: 8px 0; }

input {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border-radius: 10px;
  border: 1px solid #ddd;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

.primary { background: var(--blue); color: white; }
.secondary { background: #e5e7eb; }

small { color: #666; display: block; margin-top: 12px; }

/* APP VIEW */
#app {
  display: none;
  height: 100vh;
}

header {
  background: var(--blue);
  color: white;
  padding: 14px;
  text-align: center;
}
</style>
</head>

<body>

<!-- AUTH VIEW -->
<div id="auth" class="center">
  <div class="card">
    <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Mouse_icon.svg/512px-Mouse_icon.svg.png" />
    <h2>Welcome to AnonyMouse</h2>
    <small>Private. Anonymous. No history.</small>

    <input id="username" placeholder="Username" />
    <input id="password" type="password" placeholder="Password" />

    <button class="primary" id="loginBtn">Login</button>
    <button class="secondary" id="createBtn">Create Account</button>

    <small>⚠ No recovery. Lost = gone.</small>
  </div>
</div>

<!-- APP VIEW -->
<div id="app">
  <header>
    Welcome, <span id="displayName"></span>
  </header>
</div>

<script>
/* ============================
   SUPABASE INIT (ONLY ONCE)
============================ */
const SUPABASE_URL = "https://mdfwcpzxanraetentncb.supabase.co";
const SUPABASE_KEY = "sb_publishable_A9j8VGIbz-JikQzjbSm9vw_0qhrOLTk";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

/* ============================
   UI HELPERS
============================ */
const authView = document.getElementById("auth");
const appView = document.getElementById("app");
const displayName = document.getElementById("displayName");

function showAuth() {
  authView.style.display = "flex";
  appView.style.display = "none";
}

function showApp(username) {
  displayName.textContent = username;
  authView.style.display = "none";
  appView.style.display = "block";
}

/* ============================
   AUTH STATE (CRITICAL FIX)
============================ */
supabase.auth.onAuthStateChange(async (_event, session) => {
  if (!session) {
    showAuth();
    return;
  }

  const { data } = await supabase
    .from("profiles")
    .select("username")
    .eq("id", session.user.id)
    .single();

  showApp(data?.username || "Anonymous");
});

/* ============================
   LOGIN
============================ */
document.getElementById("loginBtn").onclick = async () => {
  const u = username.value.trim();
  const p = password.value.trim();

  if (!u || !p) return alert("Missing fields");

  const { error } = await supabase.auth.signInWithPassword({
    email: `${u}@anomymouse.local`,
    password: p
  });

  if (error) alert(error.message);
};

/* ============================
   CREATE ACCOUNT
============================ */
document.getElementById("createBtn").onclick = async () => {
  const u = username.value.trim();
  const p = password.value.trim();

  if (!u || !p) return alert("Missing fields");

  const { data, error } = await supabase.auth.signUp({
    email: `${u}@anomymouse.local`,
    password: p
  });

  if (error) return alert(error.message);

  await supabase.from("profiles").insert({
    id: data.user.id,
    username: u
  });

  alert("Account created ✔");
};
</script>

</body>
</html>
