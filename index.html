<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AnonyMouse</title>

  <!-- Supabase v2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f2f4f8;
    }
    .center {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: white;
      width: 100%;
      max-width: 360px;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.1);
      text-align: center;
    }
    h1 { margin: 12px 0 6px; }
    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    /* GLOBAL BUTTON SYSTEM */
    button {
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: #e5e7eb;
    }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-secondary { background: #f1f5f9; }
    .btn-danger { background: #fee2e2; color: #b91c1c; }
    .btn-small { padding: 6px 10px; font-size: 12px; }
    .btn-full { width: 100%; }

    #app { display: none; }

    #chatPanel {
      display: none;
      margin-top: 16px;
      border-top: 1px solid #eee;
      padding-top: 12px;
      text-align: left;
    }
    #chatMessages {
      height: 180px;
      overflow-y: auto;
      background: #f8fafc;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }
  </style>
</head>

<body>

<!-- AUTH VIEW -->
<div id="auth" class="center">
  <div class="card">
    <h1>Welcome to AnonyMouse</h1>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button class="btn-primary btn-full" id="loginBtn">Login</button>
    <button class="btn-secondary btn-full" id="signupBtn">Create Account</button>
  </div>
</div>

<!-- APP VIEW -->
<div id="app" class="center">
  <div class="card" style="max-width:320px;">
    <h1 id="welcomeText"></h1>

    <h3>ðŸ”” Friend Requests</h3>
    <div id="friendRequests"></div>

    <h3>ðŸ‘¥ Your Friends</h3>
    <div id="friendsList"></div>

    <h3>ðŸŸ¢ Online Users</h3>
    <div id="onlineUsers"></div>

    <!-- CHAT PANEL -->
    <div id="chatPanel">
      <h3 id="chatTitle">ðŸ’¬ Chat</h3>
      <div id="chatMessages">
        <p style="color:#888;">No messages yet</p>
      </div>
      <div style="display:flex; gap:6px;">
        <input id="chatInput" placeholder="Type a messageâ€¦" />
        <button class="btn-primary btn-small" id="sendBtn">Send</button>
      </div>
    </div>

    <button class="btn-primary btn-full" id="logoutBtn" style="margin-top:12px;">
      Logout
    </button>
  </div>
</div>

<script>
/* ===============================
   SUPABASE INIT
   =============================== */
const supa = window.supabase.createClient(
  "https://mdfwcpzxanraetentncb.supabase.co",
  "YOUR_ANON_KEY"
);

let myProfile = null;
let currentChatFriend = null;

/* ===============================
   VIEW SWITCHING
   =============================== */
function showAuth() {
  auth.style.display = "flex";
  app.style.display = "none";
}

async function showApp(user) {
  auth.style.display = "none";
  app.style.display = "flex";

  myProfile = await loadMyProfile(user);
  welcomeText.textContent = `Welcome, ${myProfile.username}`;

  loadOnlineUsers();
  loadFriendRequests();
  loadFriends();
}

/* ===============================
   PROFILE
   =============================== */
async function loadMyProfile(user) {
  const { data } = await supa
    .from("profiles")
    .select("*")
    .eq("id", user.id)
    .single();
  return data;
}

/* ===============================
   ONLINE USERS
   =============================== */
async function loadOnlineUsers() {
  const { data } = await supa.from("profiles").select("id, username");
  renderOnlineUsers(data);
}

function renderOnlineUsers(users) {
  onlineUsers.innerHTML = "";
  users.filter(u => u.id !== myProfile.id).forEach(user => {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.justifyContent = "space-between";

    const name = document.createElement("span");
    name.textContent = "ðŸŸ¢ " + user.username;

    const btn = document.createElement("button");
    btn.textContent = "Add Friend";
    btn.className = "btn-secondary btn-small";
    btn.onclick = () => sendFriendRequest(user.id, btn);

    row.append(name, btn);
    onlineUsers.appendChild(row);
  });
}

/* ===============================
   FRIEND REQUESTS
   =============================== */
async function loadFriendRequests() {
  const { data } = await supa
    .from("friend_requests")
    .select(`id, from_user, profiles:from_user ( username )`)
    .eq("to_user", myProfile.id)
    .eq("status", "pending");

  friendRequests.innerHTML = "";
  data.forEach(req => {
    const row = document.createElement("div");
    row.textContent = req.profiles.username;

    const accept = document.createElement("button");
    accept.textContent = "Accept";
    accept.className = "btn-primary btn-small";
    accept.onclick = () => acceptRequest(req);

    const decline = document.createElement("button");
    decline.textContent = "Decline";
    decline.className = "btn-danger btn-small";
    decline.onclick = () => declineRequest(req.id);

    row.append(accept, decline);
    friendRequests.appendChild(row);
  });
}

async function acceptRequest(req) {
  await supa.from("friends").insert([
    { user_id: myProfile.id, friend_id: req.from_user },
    { user_id: req.from_user, friend_id: myProfile.id }
  ]);
  await supa.from("friend_requests").update({ status: "accepted" }).eq("id", req.id);
  loadFriendRequests();
  loadFriends();
}

async function declineRequest(id) {
  await supa.from("friend_requests").delete().eq("id", id);
  loadFriendRequests();
}

/* ===============================
   FRIEND LIST + CHAT
   =============================== */
async function loadFriends() {
  const { data: { user } } = await supa.auth.getUser();
  const { data } = await supa
    .from("friends")
    .select(`
      user_id,
      friend_id,
      user_profile:profiles!friends_user_id_fkey ( username ),
      friend_profile:profiles!friends_friend_id_fkey ( username )
    `)
    .or(`user_id.eq.${user.id},friend_id.eq.${user.id}`);

  friendsList.innerHTML = "";
  data.forEach(row => {
    const friend = row.user_id === user.id ? row.friend_profile : row.user_profile;
    const div = document.createElement("div");
    div.textContent = friend.username;
    div.style.cursor = "pointer";
    div.onclick = () => openChat(friend);
    friendsList.appendChild(div);
  });
}

function openChat(friend) {
  currentChatFriend = friend;
  chatPanel.style.display = "block";
  chatTitle.textContent = `ðŸ’¬ Chat with ${friend.username}`;
  chatMessages.innerHTML = "<p style='color:#888;'>ðŸ”’ Secure P2P chat (connectingâ€¦)</p>";
}

/* TEMP LOCAL SEND */
sendBtn.onclick = () => {
  if (!currentChatFriend) return;
  const text = chatInput.value.trim();
  if (!text) return;
  const msg = document.createElement("div");
  msg.textContent = "You: " + text;
  chatMessages.appendChild(msg);
  chatInput.value = "";
};

/* ===============================
   AUTH
   =============================== */
supa.auth.onAuthStateChange((_, session) => {
  session ? showApp(session.user) : showAuth();
});

loginBtn.onclick = async () => {
  await supa.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
};

signupBtn.onclick = async () => {
  const { data } = await supa.auth.signUp({
    email: email.value,
    password: password.value
  });
  if (data.user) {
    await supa.from("profiles").insert({
      id: data.user.id,
      username: email.value.split("@")[0]
    });
    showApp(data.user);
  }
};

logoutBtn.onclick = async () => {
  await supa.auth.signOut();
};
</script>

</body>
</html>
