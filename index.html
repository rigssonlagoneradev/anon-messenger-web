<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Anonymous Messenger</title>

<style>
:root{
  --blue:#1877f2;
  --bg:#f0f2f5;
  --safe-top:env(safe-area-inset-top);
  --safe-bottom:env(safe-area-inset-bottom);
}
*{box-sizing:border-box;font-family:system-ui}
html,body{margin:0;height:100%;background:var(--bg)}
button,input,textarea{touch-action:manipulation;font-size:16px}

.view{height:100dvh;display:flex;flex-direction:column;background:#fff}
.header{
  background:var(--blue);color:#fff;
  padding:14px;padding-top:calc(14px + var(--safe-top));
  display:flex;justify-content:space-between;align-items:center;flex-shrink:0
}
.users,.messages{flex:1;overflow-y:auto}
.inputBar{
  padding:10px;padding-bottom:calc(10px + var(--safe-bottom));
  border-top:1px solid #ddd;flex-shrink:0
}
textarea{width:100%;padding:12px;border-radius:20px;border:1px solid #ccc}

.user{padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
.user.friend{background:#f0f8ff}
.left{display:flex;align-items:center;gap:10px}

.avatarWrap{position:relative}
.avatar{width:40px;height:40px;border-radius:50%;background:#ccc;background-size:cover;background-position:center}
.status{width:10px;height:10px;border-radius:50%;position:absolute;bottom:0;right:0;border:2px solid #fff}
.online{background:#2ecc71}
.offline{background:#aaa}

.msg{max-width:75%;margin:6px;padding:10px 14px;border-radius:18px}
.me{background:var(--blue);color:#fff;margin-left:auto}
.them{background:#e4e6eb}

.hidden{display:none}
</style>
</head>

<body>

<div id="onlineView" class="view">
  <div class="header">
    <span>Online</span>
    <div>
      <button id="contactsBtn">Contacts</button>
      <button id="profileBtn">ðŸ‘¤</button>
    </div>
  </div>
  <div class="users" id="onlineUsers"></div>
</div>

<div id="contactsView" class="view hidden">
  <div class="header">
    <button data-back>â¬…</button>
    <span>Contacts</span>
  </div>
  <div class="users" id="contactsUsers"></div>
</div>

<div id="chat" class="view hidden">
  <div class="header">
    <button data-back>â¬…</button>
    <span id="chatTitle"></span>
  </div>
  <div class="messages" id="messages"></div>
  <div class="inputBar">
    <textarea id="msgInput" rows="1" placeholder="Type a message"></textarea>
  </div>
</div>

<div id="profile" class="view hidden">
  <div class="header">
    <button data-back>â¬…</button>
    <span>Your Profile</span>
  </div>
  <input id="nameInput" placeholder="Username (optional)" style="margin:10px;padding:12px">
  <input type="file" id="avatarInput" accept="image/*" style="margin:10px">
  <button id="saveProfileBtn" style="margin:10px">Save</button>
</div>

<script>
/* ===== Identity ===== */
let myId=localStorage.getItem("anon_id")||crypto.randomUUID().replace(/-/g,"");
localStorage.setItem("anon_id",myId);

/* ===== State ===== */
let profile=JSON.parse(localStorage.getItem("profile")||"{}");
let friends=JSON.parse(localStorage.getItem("friends")||"[]");
let chatMemory={},online=new Map(),activeChat=null;

/* ===== DOM ===== */
const onlineUsers=document.getElementById("onlineUsers");
const contactsUsers=document.getElementById("contactsUsers");
const onlineView=document.getElementById("onlineView");
const contactsView=document.getElementById("contactsView");
const chat=document.getElementById("chat");
const profileView=document.getElementById("profile");
const profileBtn=document.getElementById("profileBtn");
const messages=document.getElementById("messages");
const chatTitle=document.getElementById("chatTitle");
const msgInput=document.getElementById("msgInput");
const nameInput=document.getElementById("nameInput");
const avatarInput=document.getElementById("avatarInput");

/* ===== WebSocket ===== */
const ws=new WebSocket("wss://anon-messenger-server-production.up.railway.app");

ws.onopen=()=>{
  ws.send(JSON.stringify({type:"hello",id:myId,profile}));
};

ws.onmessage=e=>{
  const d=JSON.parse(e.data);

  if(d.type==="online"){
    online=new Map(d.users.map(u=>[u.id,u]));
    render();
  }

  if(d.type==="profile_update"){
    if(online.has(d.from)){
      online.get(d.from).profile=d.profile;
      render();
    }
  }

  if(d.type==="relay"){
    const from=d.from||d.sender||d.id;
    if(!from) return;

    chatMemory[from]=chatMemory[from]||[];
    chatMemory[from].push({text:d.payload.text,who:"them"});
    if(activeChat===from)addMessage(d.payload.text,"them");
  }
};

/* ===== Rendering ===== */
function render(){
  onlineUsers.innerHTML="";
  online.forEach((u,id)=>{
    if(id===myId||friends.includes(id))return;
    onlineUsers.appendChild(userRow(id,false));
  });

  contactsUsers.innerHTML="";
  friends.forEach(id=>contactsUsers.appendChild(userRow(id,true)));
}

function userRow(id,isFriend){
  const u=online.get(id)||{};
  const div=document.createElement("div");
  div.className="user"+(isFriend?" friend":"");

  const left=document.createElement("div");
  left.className="left";

  const wrap=document.createElement("div");
  wrap.className="avatarWrap";

  const av=document.createElement("div");
  av.className="avatar";
  if(u.profile?.avatar)av.style.backgroundImage=`url(${u.profile.avatar})`;

  const st=document.createElement("div");
  st.className="status "+(online.has(id)?"online":"offline");

  wrap.append(av,st);
  const name=document.createElement("span");
  name.textContent=u.profile?.name||id.slice(0,12);
  left.append(wrap,name);

  const act=document.createElement("div");
  if(isFriend){
    const chatBtn=document.createElement("button");
    chatBtn.textContent="Chat";
    chatBtn.onclick=()=>openChat(id);

    const unfriendBtn=document.createElement("button");
    unfriendBtn.textContent="Unfriend";
    unfriendBtn.onclick=()=>{
      friends=friends.filter(x=>x!==id);
      delete chatMemory[id];
      save();render();
    };

    act.append(chatBtn,unfriendBtn);
  }

  div.append(left,act);
  return div;
}

/* ===== Chat ===== */
function openChat(id){
  activeChat=id;
  messages.innerHTML="";
  (chatMemory[id]||[]).forEach(m=>addMessage(m.text,m.who));
  chatTitle.textContent=online.get(id)?.profile?.name||id.slice(0,12);
  onlineView.classList.add("hidden");
  contactsView.classList.add("hidden");
  chat.classList.remove("hidden");
}

function addMessage(t,w){
  const d=document.createElement("div");
  d.className="msg "+w;
  d.textContent=t;
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}

msgInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){
    e.preventDefault();
    ws.send(JSON.stringify({type:"relay",to:activeChat,from:myId,payload:{text:msgInput.value}}));
    chatMemory[activeChat].push({text:msgInput.value,who:"me"});
    addMessage(msgInput.value,"me");
    msgInput.value="";
  }
});

/* ===== Profile ===== */
avatarInput.addEventListener("change",e=>{
  const r=new FileReader();
  r.onload=()=>profile.avatar=r.result;
  r.readAsDataURL(e.target.files[0]);
});
document.getElementById("saveProfileBtn").onclick=()=>{
  profile.name=nameInput.value.trim();
  localStorage.setItem("profile",JSON.stringify(profile));
  ws.send(JSON.stringify({type:"profile_update",from:myId,profile}));
  profileView.classList.add("hidden");
  onlineView.classList.remove("hidden");
};

/* ===== Navigation ===== */
document.getElementById("contactsBtn").onclick=()=>{
  onlineView.classList.add("hidden");
  contactsView.classList.remove("hidden");
};
profileBtn.onclick=()=>{
  onlineView.classList.add("hidden");
  profileView.classList.remove("hidden");
};
document.querySelectorAll("[data-back]").forEach(b=>b.onclick=()=>{
  chat.classList.add("hidden");
  contactsView.classList.add("hidden");
  profileView.classList.add("hidden");
  onlineView.classList.remove("hidden");
});

/* ===== Storage ===== */
function save(){
  localStorage.setItem("friends",JSON.stringify(friends));
}

render();
</script>
</body>
</html>
